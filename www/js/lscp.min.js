var LSCP=window.LSCP||{};LSCP.Collection=LSCP.Collection||{},LSCP.Model=LSCP.Model||{},LSCP.View=LSCP.View||{},LSCP.Data=LSCP.Data||{},LSCP.Locations=LSCP.Locations||{},LSCP.Locations.Templates="/templates/",LSCP.Locations.JSON="/data/",LSCP.Locations.Images="img/",LSCP.Locations.Sounds="audio/",LSCP.Events={APP_LOADING:"APP_LOADING"},$(window).ready(function(){LSCP.App=new LSCP.View.Base}),LSCP.SessionController=LSCP.SessionController||{current_session:null,current_game:null,current_game_view:null,init:function(){log("LSCP.SessionController initialized!")},startSession:function(){}},LSCP.Model.Action=Backbone.AssociatedModel.extend({defaults:{at:null},initialize:function(){this.set({at:new Date})}}),LSCP.Model.Config=Backbone.Model.extend({defaults:{path:""},initialize:function(){},parse:function(a){return this.path=a.path,this}}),LSCP.Model.Device=Backbone.Model.extend({defaults:{name:"Device",uuid:"unavailable",os_version:"unavailable",device_name:"Device name"},initialize:function(){this.name="My Device",this.uuid="0123456789",this.os_version="v7.0",this.device_name="iPad de Etamin Studio",log("LSCP.Model.Device initialized!",JSON.stringify(this)),this.on("change",function(){console.log("LSCP.Model.Device changed")})}}),LSCP.Model.Game=Backbone.AssociatedModel.extend({initialize:function(){log("LSCP.Model.Game initialized!")}}),LSCP.Model.GameSession=Backbone.AssociatedModel.extend({defaults:{started_at:null,time_limit:null,game:null,levels:[],actions:[],progress:0},relations:[{type:Backbone.One,key:"game",relatedModel:"LSCP.Model.Game"},{type:Backbone.Many,key:"levels",collectionType:"LSCP.Collection.LevelCollection"},{type:Backbone.Many,key:"actions",collectionType:"LSCP.Collection.ActionCollection"}],validate:function(a){return a.progress<0||a.progress>100?"Invalid progress (should be between 0 and 100)":void 0},initialize:function(){log("LSCP.Model.GameSession.initialize"),this.on("invalid",function(a,b){log("GameSession validation error:",b)}),this.on("change:progress",function(){log("New progress:",this.get("progress"))}),this.set({started_at:new Date})},saveAction:function(a,b){this.get("actions").add(new LSCP.Model.Action({action:a,value:b}))}}),LSCP.Model.Level=Backbone.AssociatedModel.extend({defaults:{name:"Untitled level",background:null,reward:null,introduce_objects:!0,feedback:!0,on_failure:null,stages:[]},relations:[{type:Backbone.Many,key:"stages",collectionType:"LSCP.Collection.StageCollection"}],initialize:function(){}}),LSCP.Model.Session=Backbone.Model.extend({initialize:function(){this.set({started_at:new Date});var a=new LSCP.Model.Game;this.games=new LSCP.Collection.GameCollection([a])}}),LSCP.Model.Stage=Backbone.Model.extend({defaults:{objects_family:null,objects_order:null,objects:[],time_idle:null,ask_for:null},initialize:function(){}}),LSCP.Collection.ActionCollection=Backbone.Collection.extend({model:LSCP.Model.Action,initialize:function(){}}),LSCP.Collection.ConfigCollection=Backbone.Collection.extend({model:LSCP.Model.Config,initialize:function(){this.loadLocalFiles()},setDefault:function(){"lscp.idevxxi.current_config"in localStorage||(localStorage["lscp.idevxxi.current_config"]=this.first())},getCurrent:function(){return localStorage["lscp.idevxxi.current_config"]},loadLocalFiles:function(){$.getJSON("data/config_files_list.json",_.bind(function(a){var b=[];_.each(a.files,_.bind(function(a){b.push(new LSCP.Model.Config({path:"data/"+a}))},this)),this.add(b)},this))},loadCurrentConfig:function(a){"lscp.idevxxi.current_config"in localStorage||(localStorage["lscp.idevxxi.current_config"]="data/config/default.json"),$.getJSON(this.getCurrent(),a)}}),LSCP.Collection.GameCollection=Backbone.Collection.extend({model:LSCP.Model.Game,initialize:function(){}}),LSCP.Collection.LevelCollection=Backbone.Collection.extend({model:LSCP.Model.Level,initialize:function(){}}),LSCP.Collection.StageCollection=Backbone.Collection.extend({model:LSCP.Model.Stage,initialize:function(){}}),LSCP.View.Base=Backbone.View.extend({el:"#app",initialize:function(){log("LSCP.View.Base initialized!")},events:{"mousedown #btn-start":"start","mousedown #btn-dashboard":"openDashboard"},start:function(a){a.preventDefault(),LSCP.Session=null,window.addToHome.close(),$("#home").hide(),LSCP.Session=new LSCP.View.Session},openDashboard:function(a){a.preventDefault(),$("#home").hide(),this.dashboard=new LSCP.View.Dashboard},render:function(){}}),LSCP.View.Dashboard=Backbone.View.extend({id:"dashboard",template_path:"templates/dashboard.html",initialize:function(){this.config_files=new LSCP.Collection.ConfigCollection,$.get(this.template_path,function(a){this.template=a,$(document).on("online",this.onOnline),$(document).on("offline",this.onOffline),this.render()}.bind(this))},events:{"mousedown .close":"close","click .config button":"changeConfig","click .sync button":"syncNow","click .log button":"eraseLog"},render:function(){var a=_.template(this.template,{current_config_file:this.config_files.getCurrent(),config_files:this.config_files.models});this.$el.html(a),0===$("#"+this.id).length&&$("#app").append(this.$el)},close:function(){this.remove(),this.unbind(),$("#home").show()},changeConfig:function(){var a=$(".config select[name=config-local]").val();log("changeConfig",a),this.addToLog("Config changed for "+a),localStorage["lscp.idevxxi.current_config"]=a,this.render()},addToLog:function(a){$("#log").append(a)},eraseLog:function(){$("#log").empty()},syncNow:function(){log("syncNow");var a=window.device||{uuid:"UUID",version:"VERSION",model:"MODEL"},b={device:{uuid:a.uuid,os_version:a.version,device_name:a.model},subject:42,sessions:[{uuid:"UUID"},{uuid:"UUID"}]};this.addToLog("test uuid: "+a.uuid),log(b);var c="http://idevxxi.acristia.org/sync/update";$.ajax({type:"POST",url:c,dataType:"json",contentType:"application/json",data:JSON.stringify(b),processData:!1,success:function(a){log("data has been successfully sent!",a)},error:function(a){log("error during sync!",a)}})},onOnline:function(){$("#syncNow").show()},onOffline:function(){$("#syncNow").hide()}}),LSCP.View.Game=Backbone.View.extend({id:"game",game_session:null,speed:1,subtitles:!1,progressbar:null,reward:null,layersSize:{},idleInterval:null,idleTimer:0,idleTime:30,imagesLoaded:!1,soundsLoaded:!1,initialize:function(){log("LSCP.View.Game initialized!"),this.game_session=this.model.get("session"),this.progressbar=new LSCP.View.ProgressBar({model:this.game_session}),this.reward=new LSCP.View.Reward,this.sound=LSCP.SoundManager.initialize(),this.layersSize={width:1024,height:768},this.pos={CENTER_CENTER:{x:"center",y:"center"},CENTER_LEFT:{x:0,y:"center"},CENTER_RIGHT:{x:"right",y:"center"},TOP_LEFT:{x:0,y:0},TOP_RIGHT:{x:"right",y:0},BOTTOM_RIGHT:{x:"right",y:"bottom"},BOTTOM_LEFT:{x:0,y:"bottom"}},this.pos=_.extend({FOR_1:[this.pos.CENTER_CENTER],FOR_2:[this.pos.CENTER_LEFT,this.pos.CENTER_RIGHT],FOR_4:[this.pos.TOP_LEFT,this.pos.TOP_RIGHT,this.pos.BOTTOM_RIGHT,this.pos.BOTTOM_LEFT]},this.pos)},render:function(){return log("LSCP.View.Game.render"),this.$el.html("").prepend(this.progressbar.el).append(this.reward.el),this},events:{mousedown:"onTouch",touchstart:"onTouch"},start:function(){log("LSCP.View.Game starts!")},end:function(){log("LSCP.View.Game ends!"),setTimeout(function(){this.trigger("end")}.bind(this),5e3/this.speed)},onIteration:function(){},onCorrectAnswer:function(){},onWrongAnswer:function(){},onNoAnswer:function(){},onIdle:function(){},onTouch:function(){this.idleTimerReset()},startWatchingIdle:function(){null===this.idleInterval&&(this.idleTimerReset(),this.idleInterval=setInterval(this.idleTimerIncrement.bind(this),1e3))},stopWatchingIdle:function(){clearInterval(this.idleInterval),this.idleInterval=null},idleTimerReset:function(){this.idleTimer=0},idleTimerIncrement:function(){this.idleTimer=this.idleTimer+1,this.idleTimer>=this.idleTime&&(this.stopWatchingIdle(),this.onIdle())},preloadImages:function(a){log("LSCP.View.Game is preloading images..."),collie.ImageManager.add(a,function(){this.imagesLoaded=!0,this.onLoaded()}.bind(this))},preloadSounds:function(a){log("LSCP.View.Game is preloading sounds..."),this.sound.addSounds(a),this.soundsLoaded=!0,this.onLoaded()},onLoaded:function(){this.imagesLoaded&&this.soundsLoaded&&this.start()}}),LSCP.View.Home=Backbone.View.extend({id:"home",path:"home.html",initialize:function(){},events:{"click #dashboard-btn":"dashboardClicked"},dashboardClicked:function(){return log("Open Dashboard"),!1}}),LSCP.View.Loading=Backbone.View.extend({id:"loading",path:"loading.html"}),LSCP.Mandy=new Object({animations:{normal:{sprite:"normal.png",values:[0],loop:0},blink:{sprite:"blink.png",values:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],loop:0},ask:{sprite:"ask.png",values:[0,0,0,0,1,0,2,3,4,5,6,6,7,8,8,9,10,10,6,6,8,8,8,11,12,13,14,0,0,0],loop:1},happy:{sprite:"happy.png",values:[0,1,2,3,4,4,4,4,4,5,6,7,8,9,1,10,11,12,12,12,12,12,13,6,7],loop:2},hello:{sprite:"hello.png",values:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,10,11,14,15,16,17,18,19,16,17,20,21,22,23,0],loop:1},sad:{sprite:"sad.png",values:[0,1,2,3,4,5,6,6,6,6,6,6,7,8,8,8,8,8,8,8,8,8,8,9,9,9,10,11,12],loop:1},bored:{sprite:"bored.png",values:[0,1,2,3,4,5,6,7,8,7,6,7,9,10,11,12,13,12,11,12,13,12,11,14,15,16,17,18,19,20,21,20,22,23,24,23,25,26,27],loop:1},idle:{sprite:"idle.png",values:[0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1],loop:1}},visible:!1,currentAnimation:null,initialize:function(){log("LSCP.Mandy initialized!"),_.each(this.animations,function(a,b){var c="normal"==b?"character":"character-"+b;collie.ImageManager.addImage(c,LSCP.Locations.Images+"character/"+a.sprite)})},addAnimations:function(a){var b={};return _.each(this.animations,function(c,d){"normal"==d?b.normal=new collie.DisplayObject({backgroundImage:"character"}).addTo(a):b[d]=new collie.DisplayObject({backgroundImage:"character-"+d,height:400,width:400,spriteLength:35,visible:!1}).addTo(a)}),b},getTimers:function(a){var b={};return _.each(this.animations,function(c,d){"normal"!=d&&(b[d]=collie.Timer.cycle(a[d],"15fps",{loop:c.loop,useAutoStart:!1,valueSet:c.values,onStart:function(){_.each(a,function(a){a.set("visible",!1)}),a[d].set("visible",!0),this.currentAnimation=d}.bind(this),onComplete:function(){this.currentAnimation==d&&(a[d].set("visible",!1),a.normal.set("visible",!0),this.currentAnimation=null)}.bind(this)}))}),b}}),LSCP.View.ProgressBar=Backbone.View.extend({id:"progressbar",initialize:function(){this.render(),this.model.bind("change",_.bind(this.render,this))},template:Handlebars.compile('<div class="bar" title="{{progress}}%"></div>'),render:function(){return this.$el.html(this.template(this.model.attributes)).find(".bar").css("width",this.model.get("progress")+"%"),this},show:function(){return this.$el.show(),this},hide:function(){return this.$el.hide(),this}}),LSCP.View.Reward=Backbone.View.extend({id:"reward",images:[],previous_image_id:null,initialize:function(){log("LSCP.View.Reward initialized!");for(var a=0;9>a;a++)this.images.push(LSCP.Locations.Images+"rewards/"+a+".jpg");this.hide()},template:Handlebars.compile('<img src="{{image}}" />'),render:function(){log("LSCP.View.Reward.render");var a=this.images.slice();null!==this.previous_image_id&&a.splice(this.previous_image_id,1);var b=_.random(0,_.size(a)-1);return this.$el.css("background-image","url("+a[b]+")").hide(),this.previous_image_id=b,this},show:function(){return this.render(),this.$el.show().on("mousedown",this.onClick.bind(this)),this},hide:function(){return this.$el.hide().off("mousedown"),this},onClick:function(){this.trigger("end")}}),LSCP.View.Session=Backbone.View.extend({el:"#session",config:null,current_game:null,current_game_session:null,current_game_view:null,initialize:function(){log("LSCP.View.Session initialized!"),(new LSCP.Collection.ConfigCollection).loadCurrentConfig(this.onConfigLoaded.bind(this))},render:function(){return this},onConfigLoaded:function(a){this.config=new LSCP.Model.Session(a),this.startSession()},startSession:function(){this.current_game=this.config.games.shift(),this.current_game_session=new LSCP.Model.GameSession(_.extend(this.config.get("session"),{game:this.current_game})),this.current_game.set("session",this.current_game_session),this.current_game_view=new LSCP.View.WordComprehensionGame({model:this.current_game}),this.$el.append(this.current_game_view.render().el),this.listenToOnce(this.current_game_view,"end",this.endSession)},endSession:function(){this.config=null,this.current_game=null,this.current_game_session=null,this.current_game_view.remove(),window.location.reload(!1)}}),LSCP.SoundManager=new Object({sounds:{},debug:!1,randomSpriteRegex:/(\D+)\d+$/,initialize:function(){return this.log("LSCP.SoundManager initialized!"),_.extend(this,Backbone.Events),this},log:function(){this.debug&&log(arguments)},addSounds:function(a){return _.each(a,this.addSound,this),this},addSound:function(a,b){return this.log("LSCP.SoundManager.addSound",a,b),a.urls=_.map(a.urls,function(a){return LSCP.Locations.Sounds+a}),this.sounds[b]=new Howl(a),this.sounds[b].randomSprites={},"undefined"!=typeof a.sprite&&_.each(a.sprite,function(a,c){var d=c.match(this.randomSpriteRegex);if(d){var e=d[1]+"*";_.has(this.sounds[b].randomSprites,e)?this.sounds[b].randomSprites[e]++:this.sounds[b].randomSprites[e]=1}},this),this},play:function(a,b){return this.log("LSCP.SoundManager.play",a,b),"undefined"!=typeof b&&-1!=b.indexOf("*")&&(b=b.replace("*",this.randomFromInterval(1,this.sounds[a].randomSprites[b]))),this.sounds[a].play(b),this},delayedPlay:function(a,b,c){_.delay(this.play.bind(this),a,b,c)},randomFromInterval:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)}}),LSCP.View.WordComprehensionGame=LSCP.View.Game.extend({current_level:null,current_stage:null,layers:{},objects:{},timers:{},$character:null,initialize:function(){LSCP.View.Game.prototype.initialize.apply(this,arguments),log("LSCP.View.WordComprehensionGame initialized!");var a=[["star",LSCP.Locations.Images+"star.png"],["slot",LSCP.Locations.Images+"slot-bg.png"],["slot-correct",LSCP.Locations.Images+"slot-correct-bg.png"],["slot-wrong",LSCP.Locations.Images+"slot-wrong-bg.png"]],b=[["mandy",{urls:["mandy/sprite.mp3"],sprite:{intro:[0,3700],hello1:[4e3,800],hello2:[5e3,700],hello3:[6e3,800],hello4:[7e3,1200],hello5:[9e3,600],right1:[1e4,1200],right2:[12e3,1900],right3:[14e3,1800],right4:[16e3,1400],right5:[18e3,1100],right6:[2e4,1500],wrong1:[3e4,1500],wrong2:[32e3,1200],wrong3:[34e3,2100],wrong4:[37e3,2100],wrong5:[4e4,1300],idle1:[5e4,900],idle2:[51e3,900],idle3:[52e3,900],idle4:[53e3,1600],idle5:[55e3,2e3],idle6:[57e3,1500],invite1:[6e4,1300],invite2:[62e3,1100],invite3:[64e3,1200],invite4:[66e3,800],invite5:[67e3,1200],bye1:[7e4,1200],bye2:[72e3,1200],bye3:[74e3,1200],bye4:[76e3,1200]}}],["plop",{urls:["plop.mp3"]}]];_.each(this.game_session.get("assets").objects,function(c,d){_.each(c,function(c){a.push(["object_"+c,LSCP.Locations.Images+"objects/"+d+"/"+c+".png"]),b.push(["object_"+c,{urls:["objects/"+d+"/"+c+"-sprite.mp3"],sprite:{ask:[0,2e3],intro:[3e3,2e3]}}])})}),_.each(this.game_session.get("assets").backgrounds,function(b){a.push(["background_"+b,LSCP.Locations.Images+"backgrounds/"+b+".jpg"])}),this.preloadImages(_.object(a)),a=null,this.preloadSounds(_.object(b)),b=null},getCurrentLevel:function(){return this.game_session.get("levels").at(this.current_level)},getCurrentStage:function(){return this.getCurrentLevel().get("stages").at(this.current_stage)},render:function(){return LSCP.View.Game.prototype.render.apply(this,arguments),log("LSCP.View.WordComprehensionGame.render"),this.layers.background=new collie.Layer(this.layersSize),this.layers.slots=new collie.Layer({x:40,y:40,width:this.layersSize.width-80,height:this.layersSize.height-80}),this.layers.character=new collie.Layer(this.layersSize),this.objects.overlay=new collie.DisplayObject({backgroundColor:"#000",height:768,width:1024,opacity:1}).addTo(this.layers.character),this.objects.character=new collie.DisplayObject({x:"center",y:800,height:400,width:400}).addTo(this.layers.character),LSCP.Mandy.initialize(),this.objects.characters=LSCP.Mandy.addAnimations(this.objects.character),this.timers.characters=LSCP.Mandy.getTimers(this.objects.characters),this.layers.hud=new collie.Layer(this.layersSize),this.objects.hud_text=new collie.Text({x:"center",y:"bottom",fontColor:"#000",fontSize:12,textAlign:"center",width:this.layersSize.width,height:100,visible:!1}).addTo(this.layers.hud),this.subtitles&&(this.objects.subtitles=new collie.Text({x:"center",y:this.layersSize.height-50,fontColor:"#FFF",fontSize:20,fontWeight:"bold",textAlign:"center",width:this.layersSize.width,height:50}).addTo(this.layers.hud)),_.each(this.layers,function(a){collie.Renderer.addLayer(a)}),collie.Renderer.load(this.el),collie.Renderer.start(),this},start:function(){LSCP.View.Game.prototype.start.apply(this,arguments),log("LSCP.View.WordComprehensionGame starts!"),this.current_level=0,this.current_stage=0,this.onIteration()},nextStage:function(){var a=this.getCurrentLevel();return this.current_stage+=1,this.current_stage>a.get("stages").size()-1?(this.reward.show().on("end",function(){this.reward.hide().off("end"),this.current_level+=1,this.current_stage=0,this.current_level>this.game_session.get("levels").size()-1?this.end():this.onIteration()}.bind(this)),void 0):(this.onIteration(),void 0)},retryStage:function(){log("RETRY STAGE: level ",this.current_level,"stage",this.current_stage),this.onIteration()},end:function(){LSCP.View.Game.prototype.end.apply(this,arguments),collie.Renderer.removeAllLayer(),collie.Renderer.unload()},onIteration:function(){LSCP.View.Game.prototype.onIteration.apply(this,arguments),log("onIteration",this.current_level,this.current_stage);var a=this.getCurrentLevel(),b=this.getCurrentStage();0===this.current_stage&&this.game_session.set({progress:0}),this.idleTime=b.get("time_idle"),this.objects.background&&this.layers.background.removeChild(this.objects.background),this.objects.background=new collie.DisplayObject({x:"center",y:"center",backgroundImage:"background_"+a.get("background"),height:768,width:1024,opacity:1}).addTo(this.layers.background),this.objects.slots=[];var c=[];if("NATURAL"==b.get("objects_positions"))c=this.pos["FOR_"+b.get("objects").length];else{if(!_.isArray(b.get("objects_positions")))throw'Wrong value for "objects_positions" on level '+this.current_level+" stage "+this.current_stage;c=_.map(b.get("objects_positions"),function(a){if("undefined"==typeof this.pos[a])throw'Wrong value "'+a+'" for "objects_positions" on level '+this.current_level+" stage "+this.current_stage;return this.pos[a]},this)}_.each(b.get("objects"),function(a,b){var d=new collie.DisplayObject({backgroundImage:"slot",opacity:0}).set(c[b]).addTo(this.layers.slots);new collie.DisplayObject({backgroundImage:"object_"+a}).addTo(d).align("center","center",d),this.objects.slots.push(d)},this),this.objects.hud_text.text("LEVEL: "+a.get("name")),collie.Timer.queue().delay(function(){this.objects.hud_text.set({visible:!0})}.bind(this),1e3/this.speed).transition(this.objects.overlay,1e3/this.speed,{from:1,to:0,set:"opacity",effect:collie.Effect.easeOutQuint}).delay(function(){a.get("introduce_objects")===!0?this.introduceObject(this.objects.slots[0],0):_.each(this.objects.slots,function(a,c){setTimeout(function(){collie.Timer.transition(this.objects.slots[c],1e3/this.speed,{from:0,to:1,set:"opacity",effect:collie.Effect.easeOutQuint}),c===b.get("objects").length-1&&setTimeout(this.onObjectsIntroduced.bind(this),2e3/this.speed)}.bind(this),1500*c/this.speed)}.bind(this))}.bind(this),0)},introduceObject:function(a,b){var c=this.getCurrentStage();this.sound.play("object_"+c.get("objects")[b],"intro"),collie.Timer.queue().transition(a,1e3/this.speed,{from:0,to:1,set:"opacity",effect:collie.Effect.easeOutQuint}).delay(function(){this.subtitles&&this.objects.subtitles.set({visible:!0}).text("♫ This is "+c.get("objects")[b]),this.startWatchingIdle(),a.attach({mousedown:function(){this.sound.play("plop");var d=a.get("y");collie.Timer.transition(a,400/this.speed,{to:d-50,set:"y",effect:collie.Effect.wave(2,.25)}),this.stopWatchingIdle(),this.subtitles&&this.objects.subtitles.set({visible:!1}),_.invoke(this.objects.slots,"set",{backgroundColor:"rgba(255,255,255,0)"}),_.invoke(this.objects.slots,"detachAll"),setTimeout(function(){b<c.get("objects").length-1?(b++,this.introduceObject(this.objects.slots[b],b)):this.onObjectsIntroduced()}.bind(this),2e3/this.speed)}.bind(this)})}.bind(this),0)},onCorrectAnswer:function(a){LSCP.View.Game.prototype.onCorrectAnswer.apply(this,arguments);var b=this.getCurrentLevel();this.stopWatchingIdle(),b.get("feedback")===!0&&(this.timers.characters.happy.start(),this.sound.play("mandy","right*"),this.subtitles&&this.objects.subtitles.set({visible:!0}).text("♫ BRAVO!"));var c=100/b.get("stages").length*(this.current_stage+1);this.game_session.set({progress:Math.floor(c)}),collie.Timer.queue().delay(function(){a.set("backgroundImage","slot-correct")}.bind(this),0).delay(function(){this.subtitles&&this.objects.subtitles.set({visible:!1})}.bind(this),0).delay(function(){collie.Timer.transition(this.objects.overlay,800/this.speed,{from:0,to:1,set:"opacity",effect:collie.Effect.easeOutQuint}),collie.Timer.transition(this.objects.character,1e3/this.speed,{from:1,to:0,set:"opacity",effect:collie.Effect.easeOutQuint})}.bind(this),3e3/this.speed).delay(function(){LSCP.Mandy.visible=!1,this.objects.character.set({opacity:1,y:800}),this.layers.slots.removeChildren(this.objects.slots),this.nextStage()}.bind(this),2e3/this.speed)},onWrongAnswer:function(a){LSCP.View.Game.prototype.onWrongAnswer.apply(this,arguments);var b=this.getCurrentLevel();this.stopWatchingIdle(),b.get("feedback")===!0?(this.timers.characters.sad.start(),this.sound.play("mandy","wrong*"),this.subtitles&&this.objects.subtitles.set({visible:!0}).text("♫ NO, YOU'RE WRONG"),a.set("backgroundImage","slot-wrong")):a.set("backgroundImage","slot-correct"),collie.Timer.queue().delay(function(){this.subtitles&&this.objects.subtitles.set({visible:!1})}.bind(this),0).delay(function(){collie.Timer.transition(this.objects.overlay,800/this.speed,{from:0,to:1,set:"opacity",effect:collie.Effect.easeOutQuint}),collie.Timer.transition(this.objects.character,1e3/this.speed,{from:1,to:0,set:"opacity",effect:collie.Effect.easeOutQuint})}.bind(this),3e3/this.speed).delay(function(){switch(LSCP.Mandy.visible=!1,this.objects.character.set({opacity:1,y:800}),this.layers.slots.removeChildren(this.objects.slots),b.get("on_failure")){case"REPEAT_STAGE":this.retryStage();break;case"CONTINUE":var a=100/b.get("stages").length*(this.current_stage+1);this.game_session.set({progress:Math.floor(a)}),this.nextStage()}}.bind(this),2e3/this.speed)},onNoAnswer:function(){LSCP.View.Game.prototype.onNoAnswer.apply(this,arguments)},onIdle:function(){LSCP.View.Game.prototype.onIdle.apply(this,arguments),LSCP.Mandy.visible?(this.sound.play("mandy","idle*"),this.timers.characters.bored.start()):this.sound.play("mandy","idle*")},onTouch:function(){LSCP.View.Game.prototype.onTouch.apply(this,arguments)},onObjectsIntroduced:function(){collie.Timer.queue().transition(this.objects.overlay,1e3/this.speed,{from:0,to:.9,set:"opacity",effect:collie.Effect.easeOutQuint}).transition(this.objects.character,1e3/this.speed,{to:200,set:"y",effect:collie.Effect.easeOutQuint}).delay(function(){this.startWatchingIdle(),LSCP.Mandy.visible=!0,this.timers.characters.hello.start(),this.sound.delayedPlay(600,"mandy","hello*"),this.objects.character.set({backgroundColor:"rgba(255,255,255,0.1)"}).attach({mousedown:function(){this.objects.character.set({backgroundColor:"rgba(255,255,255,0)"}),this.objects.character.detachAll(),this.stopWatchingIdle(),this.onTouchCharacter()}.bind(this)})}.bind(this),0)},onTouchCharacter:function(){this.sound.play("plop");var a=this.getCurrentStage();collie.Timer.queue().delay(function(){this.timers.characters.ask.start(),this.sound.delayedPlay(500,"object_"+a.get("ask_for"),"ask"),this.subtitles&&this.objects.subtitles.set({visible:!0}).text("♫ Where is the "+a.get("ask_for")+"?")}.bind(this),500/this.speed).delay(function(){_.each(this.objects.slots,function(b,c){b.attach({mousedown:function(){this.sound.play("plop"),this.game_session.saveAction("touch","slot#"+c),_.invoke(this.objects.slots,"detachAll");var d=b.get("y"),e=_.reject(this.objects.slots,function(a){return a===b});collie.Timer.queue().transition(b,400/this.speed,{to:d-50,set:"y",effect:collie.Effect.wave(2,.25)}).transition(e,400/this.speed,{from:1,to:0,set:"opacity"}).delay(function(){a.get("objects")[c]==a.get("ask_for")?this.onCorrectAnswer(b):this.onWrongAnswer(b)}.bind(this),500/this.speed)}.bind(this)})},this),this.startWatchingIdle()}.bind(this),2e3/this.speed).transition(this.objects.overlay,1e3/this.speed,{from:.9,to:0,set:"opacity",effect:collie.Effect.easeOutQuint})}});